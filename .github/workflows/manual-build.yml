name: Manual Build

on:
  workflow_dispatch:
    inputs:
      ref:
        description: 'Branch or commit to build'
        required: true
        default: 'main'
        type: string

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.generate_tag.outputs.TAG }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.ref }}

      - name: Generate tag
        id: generate_tag
        run: |
          BRANCH_NAME=$(echo "${{ github.event.inputs.ref }}" | sed 's/\//-/g')
          # Get the commit
          COMMIT_SHORT=$(git rev-parse --short HEAD)
          # Generate timestamp
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          # Create final tag
          TAG="${BRANCH_NAME}-${TIMESTAMP}-${COMMIT_SHORT}"
          echo "TAG=${TAG}" >> $GITHUB_OUTPUT
          echo "Generated tag: ${TAG}"

  build:
    needs: prepare
    uses: ./.github/workflows/build-and-push.yml
    with:
      docker_tag: ${{ needs.prepare.outputs.tag }}
      compose_tag: ${{ needs.prepare.outputs.tag }}
      push_latest: false
    secrets:
      DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}